<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BotJahl – Betalning avbruten</title>
  <meta name="description" content="Betalning avbruten. Fortsätt när du vill med Checkout eller kundportalen.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="site.css">
  <style>
    .note{font-size:13px;color:#64748b}
    .warn{color:#b45309;font-weight:600}
    .hidden{display:none!important}
  </style>
</head>
<body>
  <nav>
    <div class="container row">
      <a href="index.html" class="brand" aria-label="BotJahl startsida">
        <svg viewBox="0 0 48 48" fill="none" aria-hidden="true">
          <rect x="4" y="6" width="40" height="30" rx="10" fill="url(#g1)"/>
          <path d="M16 28c6 4 10 4 16 0" stroke="rgba(10,15,31,.7)" stroke-width="3" stroke-linecap="round"/>
          <circle cx="19" cy="20" r="2.4" fill="#0a0f1f"/>
          <circle cx="29" cy="20" r="2.4" fill="#0a0f1f"/>
          <path d="M30 38l-6-4-6 4 2.5-6.5" fill="url(#g2)" opacity=".9"/>
          <defs>
            <linearGradient id="g1" x1="4" y1="6" x2="46" y2="36"><stop stop-color="#60a5fa"/><stop offset=".6" stop-color="#22d3ee"/><stop offset="1" stop-color="#a78bfa"/></linearGradient>
            <linearGradient id="g2" x1="18" y1="32" x2="30" y2="38"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#60a5fa"/></linearGradient>
          </defs>
        </svg>
        BotJahl
      </a>
      <div class="nav-links">
        <a href="index.html#demo">Demo</a>
        <a href="admin.html" class="btn secondary">Admin</a>
        <a href="index.html" class="btn ghost">Till startsidan</a>
      </div>
    </div>
  </nav>

  <header class="page container">
    <h1>Betalning avbruten</h1>
    <p class="warn">Din provperiod finns kvar, men ingen betalmetod är sparad än. Du kan fortsätta testa och lägga till betalning när du vill.</p>
  </header>

  <main class="container grid">
    <div id="warn" class="card hidden"></div>

    <div class="card glass">
      <h2>Fortsätt när du är redo</h2>
      <div class="grid grid-auto-2auto">
        <button id="btnCheckout" class="btn primary">Fortsätt till Checkout</button>
        <button id="btnPortal" class="btn secondary">Öppna kundportal</button>
      </div>
      <p class="note" id="status"></p>
    </div>

    <div class="card glass">
      <h2>Kodsnutt till din hemsida</h2>
      <pre><code id="snippet">Laddar…</code></pre>
      <p class="note">Klistra in snutten där du vill att chatten ska visas. Du kan alltid lägga till betalning senare via kundportalen.</p>
      <div class="grid grid-auto-2auto">
        <button id="copy" class="btn secondary">Kopiera kodsnutt</button>
        <a id="home" class="btn ghost" href="./">Till startsidan</a>
      </div>
    </div>

    <div class="card glass">
      <h2>Live-förhandsvisning</h2>
      <div id="iframe-host" class="iframe-wrapper">
        <p class="muted">&nbsp;Laddar widget…</p>
      </div>
    </div>
  </main>

  <footer><div class="container">© 2025 BotJahl – Enkelt. Smart. Anpassat.</div></footer>

  <script>
  async function resolveApiBase(){
    const qs = new URLSearchParams(location.search);
    const fromQuery = qs.get("api");
    if (fromQuery) return fromQuery.replace(/\/+$/,"");
    if (window.BOTJAHL_API_BASE) return String(window.BOTJAHL_API_BASE).replace(/\/+$/,"");
    try {
      const r = await fetch("./config.json",{cache:"no-store"});
      if (r.ok){ const j = await r.json(); if (j?.apiBase) return String(j.apiBase).replace(/\/+$/,""); }
    } catch {}
    throw new Error("API-bas saknas. Använd ?api=… eller config.json.");
  }
  const API_PROMISE = resolveApiBase();
  const WIDGET = "https://westjahlconsulting.github.io/ai-chatbot-frontend/";

  (async function () {
    const qs = new URLSearchParams(location.search);
    const cid = qs.get("cid") || qs.get("customerId");
    const warn = document.getElementById("warn");
    const statusEl = document.getElementById("status");

    function showWarn(html){ warn.classList.remove("hidden"); warn.innerHTML = html; }
    if (!cid) { showWarn("<strong>Saknar kund-ID.</strong> Öppna sidan med <code>?cid=…</code>."); return; }

    const API = await API_PROMISE;
    const iframeSrc = `${WIDGET}?customerId=${encodeURIComponent(cid)}&api=${encodeURIComponent(API)}`;
    const snippet = `<iframe src="${iframeSrc}" style="width:100%;height:680px;border:0;border-radius:12px"></iframe>`;
    document.getElementById("snippet").textContent = snippet;

    const host = document.getElementById("iframe-host");
    host.innerHTML = "";
    const iframe = document.createElement("iframe");
    iframe.src = iframeSrc + "&debug=1";
    iframe.loading = "lazy";
    iframe.referrerPolicy = "no-referrer";
    iframe.sandbox = "allow-scripts allow-forms allow-same-origin";
    iframe.title = "BotJahl preview";
    host.appendChild(iframe);

    document.getElementById("copy").onclick = async () => {
      await navigator.clipboard.writeText(snippet);
      statusEl.textContent = "Kodsnutt kopierad!";
      setTimeout(()=>statusEl.textContent="", 2200);
    };

    document.getElementById("btnCheckout").onclick = async () => {
      try {
        const r = await fetch(`${API}/api/public/checkout-link?customerId=${encodeURIComponent(cid)}`);
        const data = await r.json().catch(()=> ({}));
        if (r.ok && data.url) location.href = data.url;
        else alert((data && (data.error || data.message)) || "Kunde inte öppna Checkout.");
      } catch (e) { alert("Nätverksfel mot Checkout."); }
    };

    document.getElementById("btnPortal").onclick = async () => {
      try {
        const r = await fetch(`${API}/api/billing/portal-link?customerId=${encodeURIComponent(cid)}`);
        const data = await r.json().catch(()=> ({}));
        if (r.ok && data.url) location.href = data.url;
        else alert((data && (data.error || data.message)) || "Kunde inte öppna kundportalen.");
      } catch (e) { alert("Nätverksfel mot kundportalen."); }
    };
  })();
  </script>
</body>
</html>
