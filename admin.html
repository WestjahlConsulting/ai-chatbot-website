<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BotJahl – Adminportal</title>
  <meta name="description" content="Ladda upp dokument (PDF/DOCX/TXT/MD), se status och indexera – träna din bot.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="site.css">
  <style>
    body{ overflow-x:hidden; }
    .hidden{ display:none!important; }
    .loader-backdrop{ position:fixed; inset:0; z-index:60; background:rgba(15,23,42,.55); backdrop-filter: blur(3px); display:none; align-items:center; justify-content:center; }
    .loader-backdrop.show{ display:flex; }
    .loader-card{ background:linear-gradient(135deg, rgba(255,255,255,.92), rgba(250,253,255,.92)); border:1px solid rgba(2,6,23,.08); border-radius:16px; padding:22px 26px; min-width:280px; box-shadow:0 10px 30px rgba(2,6,23,.18); display:grid; gap:10px; justify-items:center; text-align:center; }
    .spinner{ width:38px; height:38px; border-radius:50%; border:4px solid #e5e7eb; border-top-color:#60a5fa; animation:spin .9s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .loader-text{ font-weight:600; color:#0b1220; }
    .loader-sub{ font-size:13px; color:#6b7280; }
    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .file{ width:100%; }
    #log{ list-style:none; padding:0; margin:10px 0 0; display:grid; gap:6px; }
    #files{ list-style:none; padding:0; margin:0; display:grid; gap:12px; }
    #files li{ background:rgba(15,23,42,.65); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; }
    #files .row{ display:flex; gap:16px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    #files .muted{ color:#a7b0c0; }
    .glass{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:18px; }
    .stack{ display:grid; gap:16px; }
    header.page .muted{ max-width:860px; }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav>
    <div class="container row">
      <a href="index.html" class="brand" aria-label="BotJahl startsida">
        <svg viewBox="0 0 48 48" fill="none" aria-hidden="true">
          <rect x="4" y="6" width="40" height="30" rx="10" fill="url(#g1)"/>
          <path d="M16 28c6 4 10 4 16 0" stroke="rgba(10,15,31,.7)" stroke-width="3" stroke-linecap="round"/>
          <circle cx="19" cy="20" r="2.4" fill="#0a0f1f"/>
          <circle cx="29" cy="20" r="2.4" fill="#0a0f1f"/>
          <path d="M30 38l-6-4-6 4 2.5-6.5" fill="url(#g2)" opacity=".9"/>
          <defs>
            <linearGradient id="g1" x1="4" y1="6" x2="46" y2="36"><stop stop-color="#60a5fa"/><stop offset=".6" stop-color="#22d3ee"/><stop offset="1" stop-color="#a78bfa"/></linearGradient>
            <linearGradient id="g2" x1="18" y1="32" x2="30" y2="38"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#60a5fa"/></linearGradient>
          </defs>
        </svg>
        BotJahl
      </a>
      <div class="nav-links">
        <a href="index.html#demo">Demo</a>
        <a href="index.html" class="btn ghost">Till startsidan</a>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="page container">
    <span class="badge">Adminportal</span>
    <h1>Träna och hantera din bot</h1>
    <p class="muted">
      Logga in med ditt <strong>kund-ID</strong> och den <strong>e-post</strong> som angavs vid registrering.
      Här kan du ladda upp dokument (PDF/DOCX/TXT/MD), se status, reindexera och ta bort filer.
      När en fil är <strong>indexerad</strong> används dess innehåll som kontext när din bot svarar.
    </p>
  </header>

  <main class="container stack">
    <!-- LOGIN -->
    <div id="login-card" class="glass">
      <h2>Logga in</h2>
      <div class="form-row-2" style="margin-top:10px">
        <div><label for="cid">Kund-ID</label><input id="cid" placeholder="cxxxxxx" /></div>
        <div><label for="email">E-post</label><input id="email" type="email" placeholder="du@företag.se" /></div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="loginBtn" class="btn primary">Logga in</button>
        <a class="btn secondary" href="index.html">Till startsidan</a>
      </div>

      <p id="loginMsg" class="banner err hidden"></p>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">
      <div class="glass">
        <div class="actions" style="justify-content:space-between">
          <div>
            <h2>Uppladdning</h2>
            <p class="muted" style="margin:6px 0 0">Stöd: PDF, DOCX, TXT, MD. Max-storlek styrs av servern.</p>
          </div>
          <div class="actions">
            <button id="reindexAllBtn" class="btn secondary">Reindexera alla</button>
            <button id="logoutBtn" class="btn ghost">Logga ut</button>
          </div>
        </div>

        <input id="file" class="file" type="file" multiple accept=".pdf,.docx,.txt,.md" />

        <div class="actions">
          <button id="uploadBtn" class="btn primary">Ladda upp</button>
          <button id="refreshBtn" class="btn secondary">Uppdatera status</button>
        </div>
        <ul id="log"></ul>
      </div>

      <div class="glass">
        <h2>Dina dokument</h2>
        <ul id="files"></ul>
      </div>

      <div class="glass">
        <h2>Session</h2>
        <p class="muted" id="who"></p>
        <div class="actions">
          <a class="btn secondary" href="index.html">Till startsidan</a>
          <a class="btn secondary" href="success.html?cid=" id="successLink">Visa min kodsnutt</a>
        </div>
      </div>

      <!-- Quota card (visas om backend har /usage) -->
      <section id="quota-card" class="card" style="margin-top:16px; display:none">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
          <div>
            <h3 style="margin:0 0 6px">Lagringsanvändning</h3>
            <p id="quota-sub" class="muted" style="margin:0">Laddar…</p>
          </div>
          <span id="quota-pill" class="status-pill ok">0%</span>
        </div>
        <div style="margin-top:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:12px">
          <div id="quota-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#60a5fa)"></div>
        </div>
        <p class="small muted" id="quota-foot" style="margin-top:8px"></p>
      </section>
    </div>
  </main>

  <footer><div class="container">© 2025 BotJahl – Enkelt. Smart. Anpassat.</div></footer>

  <!-- Loader overlay -->
  <div id="loading" class="loader-backdrop" aria-live="polite" aria-busy="true">
    <div class="loader-card" role="dialog" aria-modal="true" aria-label="Laddar">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadingText" class="loader-text">Loggar in…</div>
      <div class="loader-sub">Ett ögonblick</div>
    </div>
  </div>

  <script>
    // === API resolver (ny) ===
    async function resolveApiBase(){
      const qs = new URLSearchParams(location.search);
      const fromQuery = qs.get("api");
      if (fromQuery) return fromQuery.replace(/\/+$/,"");

      if (window.BOTJAHL_API_BASE) return String(window.BOTJAHL_API_BASE).replace(/\/+$/,"");

      try {
        const r = await fetch("./config.json", { cache: "no-store" });
        if (r.ok) {
          const j = await r.json();
          if (j && j.apiBase) return String(j.apiBase).replace(/\/+$/,"");
        }
      } catch {}
      throw new Error("API-bas kunde inte bestämmas. Ange ?api=… eller lägg en config.json med {\"apiBase\":\"https://…\"}.");
    }
    const API_PROMISE = resolveApiBase();

    // === Element & state ===
    const qs = new URLSearchParams(location.search);
    const presetCid = qs.get("cid");
    if (presetCid) document.getElementById("cid").value = presetCid;

    const tokenKey    = "botjahl.portal.token";
    const customerKey = "botjahl.portal.customer";

    const loginCard   = document.getElementById("login-card");
    const app         = document.getElementById("app");
    const who         = document.getElementById("who");
    const filesUl     = document.getElementById("files");
    const logUl       = document.getElementById("log");
    const successLink = document.getElementById("successLink");

    const loading     = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");
    function showLoading(text){ if(text) loadingText.textContent = text; loading.classList.add("show"); }
    function hideLoading(){ loading.classList.remove("show"); }

    function setAuth(token, cid){
      if (token) {
        localStorage.setItem(tokenKey, token);
        localStorage.setItem('bj_jwt', token);
        window.dispatchEvent(new CustomEvent('bj:auth', { detail: { token } }));
      }
      if (cid) localStorage.setItem(customerKey, cid);
    }
    function getToken(){ return localStorage.getItem(tokenKey); }
    function getCid(){ return localStorage.getItem(customerKey); }
    function clearAuth(){
      localStorage.removeItem(tokenKey);
      localStorage.removeItem(customerKey);
      localStorage.removeItem('bj_jwt');
    }
    function logout(){
      clearAuth();
      app.classList.add("hidden");
      loginCard.classList.remove("hidden");
      who.textContent = "";
      filesUl.innerHTML = "";
    }

    // === Hjälpare: läs JSON om möjligt, annars text ===
    async function readBody(res){
      const text = await res.text();
      if (!text) return null;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) { try { return JSON.parse(text); } catch {} }
      return text;
    }

    // === API-wrapper som alltid prefixar rätt API-bas ===
    async function api(path, opts = {}){
      const API = await API_PROMISE;
      const headers = Object.assign({}, opts.headers || {});
      const tok = getToken();
      if (tok) headers.Authorization = "Bearer " + tok;
      if (!headers["Content-Type"] && typeof opts.body === "string") headers["Content-Type"] = "application/json";
      const res = await fetch(API + path, { ...opts, headers });
      const data = await readBody(res);
      return { res, data };
    }

    // === Status-hjälpare + auto-poll ===
    async function getStatus(){
      const { res, data } = await api("/api/uploads/status");
      if (!res.ok) return [];
      return Array.isArray(data) ? data : [];
    }

    async function pollUntilIndexed(objectNames, timeout=20000, interval=1200){
      const deadline = Date.now() + timeout;
      while(Date.now() < deadline){
        const list = await getStatus();
        const done = objectNames.every(n => list.find(x => x.objectName === n)?.indexed);
        if (done) { await refreshStatus(); return true; }
        await new Promise(r => setTimeout(r, interval));
      }
      await refreshStatus();
      return false;
    }

    // === Login ===
    async function login(){
      const customerId = document.getElementById("cid").value.trim();
      const email = document.getElementById("email").value.trim();
      const msg = document.getElementById("loginMsg");
      msg.textContent = "";
      msg.classList.add("hidden");

      try{
        showLoading("Loggar in…");
        const { res, data } = await api("/api/portal/login", {
          method: "POST",
          body: JSON.stringify({ customerId, email })
        });

        if (!res.ok) {
          const errText =
            (data && typeof data === "object" && (data.error || data.message)) ||
            (typeof data === "string" ? data : "Felaktiga uppgifter.");
          throw new Error(errText);
        }
        if (!data || !data.token) throw new Error("Servern returnerade ingen token.");

        setAuth(data.token, customerId);

        const url = new URL(location.href);
        url.searchParams.set("cid", customerId);
        url.searchParams.set("logged", "1");
        location.replace(url.toString());
      }catch(e){
        hideLoading();
        msg.textContent = e.message || "Kunde inte logga in.";
        msg.classList.remove("hidden");
      }
    }

    // === Lista status ===
    async function refreshStatus(){
      filesUl.innerHTML = "<li class='muted'>Laddar…</li>";
      const { res, data } = await api("/api/uploads/status");
      filesUl.innerHTML = "";

      if (res.status === 401) {
        filesUl.innerHTML = "<li class='banner err'>Sessionen har gått ut. Logga in igen.</li>";
        logout();
        return;
      }
      if (!res.ok) {
        const errText = (typeof data === "string" ? data : "Kunde inte hämta status.");
        filesUl.innerHTML = `<li class='banner err'>${errText}</li>`;
        return;
      }

      if (!Array.isArray(data) || data.length === 0) {
        filesUl.innerHTML = "<li class='muted'>Inga filer ännu.</li>";
        return;
      }

      for (const it of data){
        const li = document.createElement("li");
        const when = it.lastModified ? new Date(it.lastModified).toLocaleString() : "-";
        const indexedHtml = it.indexed
          ? ' • <span class="status-pill ok">indexerad' + (it.indexedAtUtc ? ' (' + new Date(it.indexedAtUtc).toLocaleString() + ')' : '') + '</span>'
          : ' • <span class="status-pill pending">ej indexerad</span>';

        li.innerHTML = `
          <div class="row">
            <div class="doc-meta">
              <strong>${(it.objectName || "").split('/').pop()}</strong>
              <div class="meta-line">
                ${(it.contentType || "okänd")} • ${it.sizeBytes ? (it.sizeBytes/1024/1024).toFixed(2)+" MB" : "-"} • Uppdaterad ${when}
                ${indexedHtml}
              </div>
              ${it.blocked ? `<div class="banner err" style="margin-top:6px">BLOCKERAD (${it.blockedCategory || "policy"}) – ${it.blockedReason || ""}</div>` : ""}
            </div>
            <div class="doc-actions">
              <button class="btn secondary" data-act="reindex" data-name="${it.objectName}">Reindex</button>
              <button class="btn ghost" data-act="delete" data-name="${it.objectName}">Ta bort</button>
            </div>
          </div>`;
        filesUl.appendChild(li);
      }

      filesUl.querySelectorAll('button[data-act="reindex"]').forEach(b => b.onclick = () => reindexOne(b.dataset.name));
      filesUl.querySelectorAll('button[data-act="delete"]').forEach(b => b.onclick = () => deleteOne(b.dataset.name));
    }

    // === Reindex ===
    async function reindexAll(){
      const before = await getStatus();
      const names = before.map(d => d.objectName);

      const { res, data } = await api("/api/uploads/reindex", {
        method: "POST",
        body: JSON.stringify({ objectName: null })
      });
      if (res.status === 401) return logout();
      if (!res.ok) alert(typeof data === "string" ? data : "Kunde inte starta reindex.");

      await pollUntilIndexed(names);
    }

    async function reindexOne(name){
      const { res, data } = await api("/api/uploads/reindex", {
        method: "POST",
        body: JSON.stringify({ objectName: name })
      });
      if (res.status === 401) return logout();
      if (!res.ok) alert(typeof data === "string" ? data : "Kunde inte reindexera filen.");
      await pollUntilIndexed([name]);
    }

    // === Delete ===
    async function deleteOne(name){
      if(!confirm("Ta bort filen?")) return;
      const { res, data } = await api("/api/uploads/file", {
        method: "DELETE",
        body: JSON.stringify({ objectName: name })
      });
      if (res.status === 401) return logout();
      if (!res.ok) alert(typeof data === "string" ? data : "Kunde inte ta bort filen.");
      await refreshStatus();
    }

    // === Upload ===
    async function upload(){
      const files = document.getElementById("file").files;
      if(!files || files.length===0) return;

      const uploadedObjectNames = [];

      for (const f of files){
        const li = document.createElement("li");
        li.textContent = `Laddar upp ${f.name}…`;
        logUl.appendChild(li);

        // 1) Start
        let start;
        try{
          start = await api("/api/uploads/start", {
            method:"POST",
            body: JSON.stringify({ fileName: f.name, contentType: f.type || "application/octet-stream" })
          });
        }catch(err){
          li.textContent = `Nätverksfel (start): ${err?.message || err}`;
          continue;
        }
        if (start.res.status === 401) { logout(); return; }
        if (!start.res.ok || !start.data || !start.data.uploadUrl){
          li.textContent = `Fel vid start: ${typeof start.data === "string" ? start.data : "okänt fel"}`;
          continue;
        }

        // 2) PUT till SAS
        try{
          const put = await fetch(start.data.uploadUrl, {
            method: "PUT",
            headers: { "x-ms-blob-type":"BlockBlob", "Content-Type": f.type || "application/octet-stream" },
            body: f
          });
          if (!put.ok){
            li.textContent = `Fel vid PUT: ${put.status}`;
            continue;
          }
        }catch(err){
          li.textContent = `Nätverksfel (PUT): ${err?.message || err}`;
          continue;
        }

        // 3) Complete
        try{
          const comp = await api("/api/uploads/complete", {
            method:"POST",
            body: JSON.stringify({
              objectName: start.data.objectName,
              sizeBytes: f.size,
              contentType: f.type || "application/octet-stream"
            })
          });
          if (!comp.res.ok){
            li.textContent = `Fel vid complete: ${typeof comp.data === "string" ? comp.data : "okänt fel"}`;
            continue;
          }
        }catch(err){
          li.textContent = `Nätverksfel (complete): ${err?.message || err}`;
          continue;
        }

        uploadedObjectNames.push(start.data.objectName);
        li.innerHTML = `<span class="status-ok">✔</span> Klar: ${f.name}`;
      }

      if (uploadedObjectNames.length){
        await pollUntilIndexed(uploadedObjectNames);
      }else{
        await refreshStatus();
      }
    }

    // === Event hooks ===
    document.getElementById("loginBtn").onclick   = login;
    document.getElementById("logoutBtn").onclick  = logout;
    document.getElementById("refreshBtn").onclick = refreshStatus;
    document.getElementById("uploadBtn").onclick  = upload;
    document.getElementById("reindexAllBtn").onclick = reindexAll;
    document.getElementById("email").addEventListener("keydown", (e)=>{ if (e.key === "Enter") login(); });

    // === Boot ===
    (async function boot(){
      const token = getToken();
      const cid   = getCid();
      if (token && cid){
        loginCard.classList.add("hidden");
        app.classList.remove("hidden");
        who.textContent = `Inloggad (${cid})`;
        successLink.href = "success.html?cid=" + encodeURIComponent(cid);
        await refreshStatus();

        const url = new URL(location.href);
        if (url.searchParams.has("logged")) {
          url.searchParams.delete("logged");
          history.replaceState({}, "", url.toString());
        }
      }
    })();
  </script>

  <!-- Quota-kort (oförändrat i sak, använder token i localStorage) -->
  <script>
  (function(){
    let API_BASE = "";
    (async ()=>{ try{ API_BASE = await API_PROMISE; }catch{} })();

    function readCookie(name){
      const m = document.cookie.match(new RegExp('(?:^|; )' + name.replace(/([$?*|{}\(\)\[\]\\\/\+^])/g,'\\$1') + '=([^;]*)'));
      return m ? decodeURIComponent(m[1]) : null;
    }
    function getToken(){
      const qs = new URLSearchParams(location.search);
      const fromUrl = qs.get('token') || qs.get('jwt');
      if (fromUrl) return fromUrl;
      const keys = ['botjahl.portal.token','bj_jwt','jwt','token','auth_token'];
      for (const k of keys){
        const v = localStorage.getItem(k) || sessionStorage.getItem(k);
        if (v) return v;
      }
      if (window.JWT) return window.JWT;
      const cookieKeys = ['bj_jwt','jwt','token','botjahl.portal.token'];
      for (const ck of cookieKeys){
        const v = readCookie(ck);
        if (v) return v;
      }
      return '';
    }
    async function fetchUsage(token){
      const res = await fetch(`${API_BASE}/api/uploads/usage`, { headers: { "Authorization": `Bearer ${token}` } });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      return res.json();
    }
    const card = document.getElementById("quota-card");
    const sub  = document.getElementById("quota-sub");
    const pill = document.getElementById("quota-pill");
    const bar  = document.getElementById("quota-bar");
    const foot = document.getElementById("quota-foot");
    function render(u){
      card.style.display = "";
      sub.textContent = `Plan: ${u.plan} • ${u.files} fil(er)`;
      bar.style.width = `${u.percent}%`;
      pill.textContent = `${u.percent}%`;
      pill.className = "status-pill " + (u.percent >= 100 ? "pending" : "ok");
      foot.textContent = `${u.usedMB} MB av ${u.limitMB} MB använt`;
    }
    function renderLoggedOut(){
      card.style.display = "";
      sub.textContent = "Logga in för att se användning.";
      pill.textContent = "—";
      bar.style.width = "0%";
      foot.textContent = "";
    }
    async function tick(){
      const token = getToken();
      if (!token){ renderLoggedOut(); return; }
      try{ const u = await fetchUsage(token); render(u); }
      catch{ card.style.display=""; sub.textContent="Kunde inte läsa användning."; pill.textContent="—"; }
    }
    window.addEventListener('storage', (e) => {
      if (['botjahl.portal.token','bj_jwt','jwt','token','auth_token'].includes(e.key)) tick();
    });
    window.addEventListener('bj:auth', () => tick());
    (async ()=>{ try{ API_BASE = await API_PROMISE; tick(); setInterval(tick,15000);}catch{} })();
  })();
  </script>
</body>
</html>
