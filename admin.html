<!DOCTYPE html>
<html lang="sv">
<head>
  <script>
    window.API_BASE = "__API_BASE__"; // inject vid deployment
  </script>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>BotJahl ‚Äì Adminportal</title>
  <meta name="description" content="Ladda upp dokument (PDF/DOCX/TXT/MD), se status och indexera ‚Äì tr√§na din bot.">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="site.css">
  <style>
    body{ overflow-x:hidden; }
    .hidden{ display:none!important; }

    .loader-backdrop{ position:fixed; inset:0; z-index:60; background:rgba(15,23,42,.55); backdrop-filter: blur(3px); display:none; align-items:center; justify-content:center; }
    .loader-backdrop.show{ display:flex; }
    .loader-card{ background:linear-gradient(135deg, rgba(255,255,255,.92), rgba(250,253,255,.92)); border:1px solid rgba(2,6,23,.08); border-radius:16px; padding:22px 26px; min-width:280px; box-shadow:0 10px 30px rgba(2,6,23,.18); display:grid; gap:10px; justify-items:center; text-align:center; }
    .spinner{ width:38px; height:38px; border-radius:50%; border:4px solid #e5e7eb; border-top-color:#60a5fa; animation:spin .9s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }
    .loader-text{ font-weight:600; color:#0b1220; }
    .loader-sub{ font-size:13px; color:#6b7280; }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .file{ width:100%; }
    .upload-area{
      margin-top:16px;
      display:grid;
      gap:12px;
      align-items:flex-start;
    }

    #log{ list-style:none; padding:0; margin:10px 0 0; display:grid; gap:6px; }
    #files{ list-style:none; padding:0; margin:0; display:grid; gap:12px; }
    #files li{ background:rgba(15,23,42,.65); border:1px solid rgba(255,255,255,.08); border-radius:12px; padding:12px; }
    #files .row{ display:flex; gap:16px; justify-content:space-between; align-items:flex-start; flex-wrap:wrap; }
    #files .muted{ color:#a7b0c0; }

    .glass{ background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); border-radius:16px; padding:18px; }
    .stack{ display:grid; gap:16px; }

    header.page .muted{ max-width:860px; }

    .status-pill{ display:inline-flex; align-items:center; justify-content:center; min-width:62px; padding:2px 9px; border-radius:999px; font-size:12px; font-weight:600; }
    .status-pill.ok{ background:rgba(22,163,74,.16); color:#bbf7d0; }
    .status-pill.pending{ background:rgba(234,179,8,.16); color:#facc15; }

    .small{ font-size:12px; }

    #fileSearch{
      width:100%;
      padding:12px 14px;
      border:1px solid rgba(255,255,255,.15);
      background:#0f172a;
      color:#e5e7eb;
      border-radius:12px;
      font-size:16px;
    }
    #fileSearch::placeholder{
      color:#8ea0b5;
    }
    #fileSearch:focus{
      outline:0;
      border-color:#3b82f6;
      box-shadow:0 0 0 3px rgba(59,130,246,.25);
    }
  </style>
</head>
<body>
  <!-- NAV -->
  <nav>
    <div class="container row">
      <a href="index.html" class="brand" aria-label="BotJahl startsida">
        <svg viewBox="0 0 48 48" fill="none" aria-hidden="true">
          <rect x="4" y="6" width="40" height="30" rx="10" fill="url(#g1)"/>
          <path d="M16 28c6 4 10 4 16 0" stroke="rgba(10,15,31,.7)" stroke-width="3" stroke-linecap="round"/>
          <circle cx="19" cy="20" r="2.4" fill="#0a0f1f"/>
          <circle cx="29" cy="20" r="2.4" fill="#0a0f1f"/>
          <path d="M30 38l-6-4-6 4 2.5-6.5" fill="url(#g2)" opacity=".9"/>
          <defs>
            <linearGradient id="g1" x1="4" y1="6" x2="46" y2="36"><stop stop-color="#60a5fa"/><stop offset=".6" stop-color="#22d3ee"/><stop offset="1" stop-color="#a78bfa"/></linearGradient>
            <linearGradient id="g2" x1="18" y1="32" x2="30" y2="38"><stop stop-color="#22d3ee"/><stop offset="1" stop-color="#60a5fa"/></linearGradient>
          </defs>
        </svg>
        BotJahl
      </a>
      <div class="nav-links">
        <a href="index.html#demo">Demo</a>
        <a href="index.html" class="btn ghost">Till startsidan</a>
      </div>
    </div>
  </nav>

  <!-- HEADER -->
  <header class="page container">
    <span class="badge">Adminportal</span>
    <h1>Tr√§na och hantera din bot</h1>
    <p id="introText" class="muted"></p>
  </header>

  <main class="container stack">
    <!-- Banner f√∂r k√∂p av extra fr√•gor -->
    <p id="topupBanner" class="banner ok hidden" style="margin-bottom:0;"></p>

    <!-- LOGIN -->
    <div id="login-card" class="glass">
      <h2>Logga in</h2>
      <div class="form-row-2" style="margin-top:10px">
        <div><label for="cid">Kund-ID</label><input id="cid" placeholder="cxxxxxx" /></div>
        <div><label for="email">E-post</label><input id="email" type="email" placeholder="du@f√∂retag.se" /></div>
      </div>

      <div class="actions" style="margin-top:12px">
        <button id="loginBtn" class="btn primary">Logga in</button>
        <a class="btn secondary" href="index.html">Till startsidan</a>
      </div>

      <p id="loginMsg" class="banner err hidden"></p>
    </div>

    <!-- APP -->
    <div id="app" class="hidden">

      <!-- Konto-inst√§llningar + inloggningsrad -->
      <section id="account-card" class="glass stack" style="margin-bottom:16px;">
        <div>
          <h2>Konto-inst√§llningar</h2>
          <p class="muted small">
            H√§r har du m√∂jlighet att uppdatera f√∂retagsnamn, e-post och dom√§n. Dom√§nen styr var chatten f√•r k√∂ras
            och vilken webbplats som indexeras. Gl√∂m inte att klicka p√• "Spara √§ndringar" efter uppdatering.
          </p>

          <div class="form-row-2" style="margin-top:10px;">
            <div>
              <label for="accName">F√∂retagsnamn</label>
              <input id="accName" maxlength="80" placeholder="F√∂retag AB" />
            </div>
            <div>
              <label for="accEmail">E-post f√∂r kontot</label>
              <input id="accEmail" type="email" maxlength="200" placeholder="du@f√∂retag.se" />
            </div>
          </div>

          <div style="margin-top:10px;">
            <label for="accDomain">Dom√§n</label>
            <input id="accDomain" maxlength="255" placeholder="https://www.dittf√∂retag.se" />
            <p class="small muted">
              Exempel: <code>https://www.dittf√∂retag.se</code>. Vi till√•ter bara riktiga dom√§nnamn
            </p>
          </div>

          <div class="actions" style="margin-top:12px;">
            <button id="saveAccountBtn" class="btn secondary">Spara √§ndringar</button>
          </div>

          <p id="accountMsg" class="banner small muted"></p>
        </div>

        <div class="actions"
             style="justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap;">
          <!-- V√§nster: kundinfo -->
          <div style="display:flex;flex-direction:column;gap:2px;min-width:0;">
            <p id="who" class="muted" style="margin:0;font-weight:500;"></p>
            <p id="whoDomain" class="muted small" style="margin:0;"></p>
          </div>

          <!-- H√∂ger: knappar -->
          <div class="actions" style="gap:8px;flex-wrap:wrap;">
            <button id="deleteAccountBtn"
                    class="btn ghost small"
                    style="border-color:#f97373;color:#fecaca;">
              Radera konto
            </button>

            <button id="logoutBtn" class="btn ghost small">Logga ut</button>

            <a id="successLink" class="btn secondary" href="success.html">
              Visa kodsnutt &amp; hantera betalning
            </a>
          </div>
        </div>
      </section>
      <!-- Chat-utseende -->
<section class="glass stack" id="theme-card" style="margin-top:16px;">
  <h2>Chat-utseende</h2>
  <p class="muted small">
    H√§r kan du √§ndra hur chatten ser ut p√• din webbplats. Resultatet syns b√•de i f√∂rhandsvisningen
    nedan och p√• sidan med kodsnutten.
  </p>

  <!-- Chat-ikon -->
  <div class="field-group">
    <label class="field-label">Chat-ikon</label>
    <p class="muted small" style="margin-bottom:6px;">
      V√§lj en ikon-stil eller anv√§nd en egen emoji.
    </p>

    <!-- Preset-ikoner i v√•gr√§t rad -->
  <div id="iconChoices" class="icon-choices">
    <!-- 1) Rund pratbubbla -->
    <button type="button" class="icon-choice" data-icon-value="preset:bubble" aria-label="Pratbubbla">
      <span class="icon-inner">
        <svg viewBox="0 0 40 40" aria-hidden="true">
          <circle cx="20" cy="20" r="18" fill="#111827"/>
          <rect x="12" y="13" width="16" height="11" rx="3"
                fill="#0b1120" stroke="#f9fafb" stroke-width="2"/>
        </svg>
      </span>
    </button>

    <!-- 2) Fylld chattbubbla -->
    <button type="button" class="icon-choice" data-icon-value="preset:chat" aria-label="Fylld chattbubbla">
      <span class="icon-inner">
        <svg viewBox="0 0 40 40" aria-hidden="true">
          <circle cx="20" cy="20" r="18" fill="#0b1120"/>
          <path d="M13 14h14a2 2 0 0 1 2 2v7a2 2 0 0 1-2 2h-6l-4 3v-3h-4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2z"
                fill="#f9fafb"/>
        </svg>
      </span>
    </button>

    <!-- 3) Robot -->
    <button type="button" class="icon-choice" data-icon-value="preset:robot" aria-label="Robot-ikon">
      <span class="icon-inner">
        <svg viewBox="0 0 40 40" aria-hidden="true">
          <circle cx="20" cy="20" r="18" fill="#111827"/>
          <rect x="11" y="14" width="18" height="12" rx="4" fill="#e5e7eb"/>
          <circle cx="17" cy="19" r="1.6" fill="#0f172a"/>
          <circle cx="23" cy="19" r="1.6" fill="#0f172a"/>
          <rect x="17" y="23" width="6" height="1.4" rx="0.7" fill="#0f172a"/>
        </svg>
      </span>
    </button>

    <!-- 4) Blixt -->
    <button type="button" class="icon-choice" data-icon-value="preset:bolt" aria-label="Blixt-ikon">
      <span class="icon-inner">
        <svg viewBox="0 0 40 40" aria-hidden="true">
          <circle cx="20" cy="20" r="18" fill="#111827"/>
          <path d="M22 10l-10 12h6l-2 8 10-13h-6z" fill="#facc15"/>
        </svg>
      </span>
    </button>

    <!-- Emoji-l√§ge -->
    <button type="button" class="icon-choice" data-icon-value="emoji" aria-label="Egen emoji">
      <span class="icon-inner">üòä</span>
    </button>
  </div>


    <!-- Rad f√∂r egen emoji (visas bara om man valt emoji-l√§get) -->
    <div id="emojiRow" class="emoji-row hidden" style="margin-top:8px;">
      <label for="themeLauncherEmoji" class="small muted">Egen ikon (emoji)</label>
      <input id="themeLauncherEmoji"
             maxlength="4"
             placeholder="t.ex. üí¨"
             style="max-width:140px;" />
    </div>

    <!-- Dolt f√§lt som faktiskt skickas till backend -->
    <input id="themeLauncherIcon" type="hidden" />
  </div>

  <!-- Prim√§r f√§rg -->
  <div class="field-group">
    <label for="themePrimaryColor" class="field-label">Prim√§r f√§rg</label>
    <div class="color-row">
      <input id="themePrimaryColor" type="color" value="#2563eb" />
      <span class="muted small">Anv√§nds f√∂r knappar och chat-knappens bakgrund.</span>
    </div>
  </div>

  <!-- Bubbel-f√§rger -->
  <div class="field-group">
    <label class="field-label">F√§rg p√• bubblor</label>
    <div class="color-row">
      <div>
        <label for="themeUserBubble" class="small muted">Dina bubblor</label><br />
        <input id="themeUserBubble" type="color" value="#eef2ff" />
      </div>
      <div>
        <label for="themeBotBubble" class="small muted">Botens bubblor</label><br />
        <input id="themeBotBubble" type="color" value="#dcfce7" />
      </div>
    </div>
  </div>

  <!-- Typsnitt -->
  <div class="field-group">
    <label for="themeFont" class="field-label">Typsnitt i chatten</label>
    <select id="themeFont">
      <option value="">System/UI (standard)</option>
      <option value="Inter, system-ui, -apple-system, Segoe UI, sans-serif">Inter</option>
      <option value="Georgia, 'Times New Roman', serif">Serif</option>
      <option value="'Courier New', ui-monospace, SFMono-Regular, Menlo, Consolas, monospace">
        Monospace
      </option>
    </select>
    <p class="muted small">
      Typsnittet p√•verkar bara sj√§lva chatten ‚Äì inte resten av din webbplats.
    </p>
  </div>

  <div class="actions" style="margin-top:12px;">
    <button id="themeSaveBtn" class="btn primary">Spara utseende</button>
    <button id="themeResetBtn" class="btn secondary">√Öterst√§ll standard</button>
  </div>

  <p id="themeMsg" class="banner small muted" style="margin-top:6px;"></p>
</section>


      <!-- Uppdaterad F√∂rhandsvisning -->
      <section class="glass stack" style="margin-top:16px;">
        <h2>F√∂rhandsvisning</h2>
        <p class="muted small">
          S√• h√§r ser din chat ut med dina nuvarande inst√§llningar.
          F√∂rhandsvisningen p√•verkar inte din hemsida f√∂rr√§n du b√§ddar in koden d√§r.
        </p>

        <div style="border-radius:12px; overflow:hidden; border:1px solid #e5e7eb;">
          <iframe
            id="chatPreviewFrame"
            title="F√∂rhandsvisning av chat"
            srcdoc="<p style='font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#64748b'>Laddar f√∂rhandsvisning‚Ä¶</p>"
            style="width:100%; height:520px; border:0; background:#020617;">
          </iframe>
        </div>

        <button id="reloadPreviewBtn" class="btn ghost small" style="margin-top:8px;">
          Uppdatera f√∂rhandsvisning
        </button>
      </section>

      <!-- Uppladdning + dokument -->
      <div class="glass">
        <div class="actions" style="justify-content:space-between">
          <div>
            <h2>Uppladdning</h2>
            <p class="muted" style="margin:6px 0 4px">
              St√∂d: PDF, DOCX, TXT, MD. Max-storlek styrs av servern.
            </p>
            <p class="small muted" style="margin:0">
              <strong>Tips:</strong> Anv√§nd
              <em>Reindexera webbplatsen</em> n√§r du √§ndrat inneh√•ll p√• din hemsida
              och <em>Reindexera alla dokument</em> n√§r du vill att boten ska l√§sa in dina uppladdade
              filer p√• nytt.
            </p>
          </div>
          <div class="actions">
            <button id="reindexSiteBtn" class="btn secondary">Reindexera webbplatsen</button>
            <button id="reindexAllBtn" class="btn secondary">Reindexera alla dokument</button>
          </div>
        </div>

        <div class="upload-area">
          <input id="file" class="file" type="file" multiple accept=".pdf,.docx,.txt,.md" />

          <div class="actions">
            <button id="uploadBtn" class="btn primary">Ladda upp</button>
            <button id="refreshBtn" class="btn secondary">Uppdatera status</button>
          </div>
        </div>

        <ul id="log"></ul>

        <div class="glass" style="margin-top:16px;">
          <h2>Dina dokument</h2>

          <!-- S√∂k + sortering -->
          <div class="actions" style="margin:4px 0 10px; flex-wrap:wrap; gap:8px; align-items:flex-end;">
            <div style="flex:1; min-width:200px;">
              <label for="fileSearch" class="small muted">S√∂k bland dina dokument</label>
              <input id="fileSearch" type="text" placeholder="S√∂k p√• filnamn eller filtyp‚Ä¶" />
            </div>
            <button id="sortByNameBtn" type="button" class="btn secondary small">
              Sortera A‚Äì√ñ
            </button>
          </div>

          <ul id="files"></ul>
        </div>

        <!-- Quota card -->
        <section id="quota-card" class="card" style="margin-top:16px; display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0 0 6px">Lagringsanv√§ndning</h3>
              <p id="quota-sub" class="muted" style="margin:0">Laddar‚Ä¶</p>
              <p class="small muted" id="quota-domain" style="display:none;"></p>
            </div>
            <span id="quota-pill" class="status-pill ok">0%</span>
          </div>

          <div style="margin-top:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:12px">
            <div id="quota-bar" style="height:100%;width:0%;background:linear-gradient(90deg,#22d3ee,#60a5fa)"></div>
          </div>

          <p class="small muted" id="quota-foot" style="margin-top:8px"></p>
        </section>

        <!-- Chat-fr√•gor / statistik -->
        <section id="chat-usage-card" class="card" style="margin-top:16px; display:none">
          <div style="display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap">
            <div>
              <h3 style="margin:0 0 6px">Fr√•geanv√§ndning</h3>
              <p id="chat-usage-sub" class="muted" style="margin:0">Laddar‚Ä¶</p>
            </div>
            <span id="chat-usage-pill" class="status-pill ok">0%</span>
          </div>

          <div style="margin-top:10px;background:rgba(255,255,255,.12);border-radius:999px;overflow:hidden;height:12px">
            <div id="chat-usage-bar"
                 style="height:100%;width:0%;background:linear-gradient(90deg,#22c55e,#16a34a);border-radius:999px;">
            </div>
          </div>

          <div id="chat-usage-foot" class="small muted" style="margin-top:8px"></div>

          <div style="margin-top:14px;display:flex;justify-content:flex-end;">
            <button id="buyQuestionsBtn" type="button" class="btn primary small">
              K√∂p fler fr√•gor
            </button>
          </div>
        </section>
      </div>
    </div>
  </main>

  <footer>
    <div class="container">
      ¬© 2025 BotJahl ‚Äì Enkelt. Smart. Anpassat.
      ¬∑ <a href="terms.html">Anv√§ndarvillkor</a>
      ¬∑ <a href="privacy.html">Integritetspolicy</a>
      ¬∑ <a href="dpa.html">Personuppgiftsbitr√§desavtalet (DPA)</a>
    </div>
  </footer>

  <!-- Loader overlay -->
  <div id="loading" class="loader-backdrop" aria-live="polite" aria-busy="true">
    <div class="loader-card" role="dialog" aria-modal="true" aria-label="Laddar">
      <div class="spinner" aria-hidden="true"></div>
      <div id="loadingText" class="loader-text">Loggar in‚Ä¶</div>
      <div class="loader-sub">Ett √∂gonblick</div>
    </div>
  </div>

  <!-- Huvudscript (login + uppladdning + status + tema) -->
  <script>
    const rawApi = (
      new URLSearchParams(location.search).get("api") ||
      window.API_BASE ||
      window.API ||
      ""
    ).trim();

    if (!rawApi) {
      console.error("API_BASE saknas! Kontrollera att __API_BASE__ har injicerats");
    }

    const API = rawApi.replace(/\/+$/, "");

    const qs = new URLSearchParams(location.search);
    const presetCid = qs.get("cid");
    if (presetCid) document.getElementById("cid").value = presetCid;

    const tokenKey    = "botjahl.portal.token";
    const customerKey = "botjahl.portal.customer";

    // ---- Topup-banner ----
    const topupBanner = document.getElementById("topupBanner");
    const topup       = qs.get("topup");
    const topupQStr   = qs.get("questions");
    const topupQ      = topupQStr ? parseInt(topupQStr, 10) : NaN;

    if (topupBanner && topup === "ok") {
      const qText =
        !isNaN(topupQ) && topupQ > 0
          ? ` Du har k√∂pt ${topupQ.toLocaleString("sv-SE")} extra fr√•gor.`
          : " Du har k√∂pt fler fr√•gor.";

      topupBanner.classList.remove("hidden");
      topupBanner.classList.remove("err");
      topupBanner.classList.add("ok");
      topupBanner.innerHTML = `üéâ <strong>Klart!</strong>${qText}`;
    } else if (topupBanner && topup === "cancel") {
      topupBanner.classList.remove("hidden");
      topupBanner.classList.remove("ok");
      topupBanner.classList.add("err");
      topupBanner.innerHTML =
        "K√∂p av extra fr√•gor avbr√∂ts. Du kan f√∂rs√∂ka igen n√§r du vill.";
    }

    // Rensa bort topup-parametrar ur adressen efter visning
    if (topup) {
      qs.delete("topup");
      qs.delete("questions");
      const url = new URL(location.href);
      url.search = qs.toString();
      window.history.replaceState({}, "", url.toString());
    }

    const loginCard   = document.getElementById("login-card");
    const app         = document.getElementById("app");
    const who         = document.getElementById("who");
    const filesUl     = document.getElementById("files");
    const logUl       = document.getElementById("log");
    const successLink = document.getElementById("successLink");
    const whoDomain   = document.getElementById("whoDomain");

    
    // --- Chat-utseende DOM ---
    const themeLauncherIconInput   = document.getElementById("themeLauncherIcon");
    const themeLauncherEmojiInput  = document.getElementById("themeLauncherEmoji");
    const iconButtons              = Array.from(document.querySelectorAll(".icon-choice"));
    const emojiRow                 = document.getElementById("emojiRow");

    const themePrimaryColor        = document.getElementById("themePrimaryColor");
    const themeUserBubble          = document.getElementById("themeUserBubble");
    const themeBotBubble           = document.getElementById("themeBotBubble");
    const themeFont                = document.getElementById("themeFont");
    const themeMsg                 = document.getElementById("themeMsg");

    const themePrimaryCodeSpan     = document.getElementById("themePrimaryCode");
    const themeUserCodeSpan        = document.getElementById("themeUserCode");
    const themeBotCodeSpan         = document.getElementById("themeBotCode");

    const themeSaveBtn             = document.getElementById("themeSaveBtn");
    const themeResetBtn            = document.getElementById("themeResetBtn");


    // F√∂rhandsvisning
    const chatPreviewFrame       = document.getElementById("chatPreviewFrame");
    const reloadPreviewBtn       = document.getElementById("reloadPreviewBtn");
    const WIDGET_URL             = "https://westjahlconsulting.github.io/ai-chatbot-frontend/widget.html";

    function makeSid() {
      return (self.crypto && crypto.randomUUID && crypto.randomUUID()) ||
             (Date.now().toString(36) + Math.random().toString(36).slice(2));
    }


    function setLauncherIconValue(modeOrValue) {
      if (!themeLauncherIconInput) return;

      // emoji-l√§ge ‚Üí anv√§nd emoji-f√§ltet
      if (modeOrValue === "emoji") {
        const emoji = (themeLauncherEmojiInput?.value || "").trim();
        themeLauncherIconInput.value = emoji || "üí¨";
      } else {
        // presets, t.ex. "preset:bubble"
        themeLauncherIconInput.value = modeOrValue || "preset:bubble";
      }

      // uppdatera vilken knapp som √§r aktiv
      iconButtons.forEach(btn => {
        const v = btn.getAttribute("data-icon-value");
        btn.classList.toggle(
          "active",
          v === modeOrValue ||
          (modeOrValue && !modeOrValue.startsWith("preset:") && v === "emoji")
        );
      });

      // visa/g√∂m emoji-raden
      if (emojiRow) {
        const isEmoji =
          modeOrValue === "emoji" ||
          (themeLauncherIconInput.value && !themeLauncherIconInput.value.startsWith("preset:"));
        emojiRow.classList.toggle("hidden", !isEmoji);
      }
    }



        // Ikon-knappar
    iconButtons.forEach(btn => {
      btn.addEventListener("click", () => {
        const v = btn.getAttribute("data-icon-value") || "";
        setLauncherIconValue(v);
      });
    });

    if (themeLauncherEmojiInput) {
      themeLauncherEmojiInput.addEventListener("input", () => {
        setLauncherIconValue("emoji");
      });
    }
    // default-val tills /me laddats
    setLauncherIconValue("preset:bubble");





    // S√∂k + sort dokument
    const fileSearchInput = document.getElementById("fileSearch");
    const sortByNameBtn   = document.getElementById("sortByNameBtn");
    let filesCache        = [];
    let sortAscending     = true;

    // Konto-inst√§llningar
    const accNameInput   = document.getElementById("accName");
    const accEmailInput  = document.getElementById("accEmail");
    const accDomainInput = document.getElementById("accDomain");
    const accountMsg     = document.getElementById("accountMsg");

    // Tema DOM
    const themeLauncherIcon = document.getElementById("themeLauncherIcon");

    const loading     = document.getElementById("loading");
    const loadingText = document.getElementById("loadingText");
    function showLoading(text){ if(text) loadingText.textContent = text; loading.classList.add("show"); }
    function hideLoading(){ loading.classList.remove("show"); }

    function esc(value){
      return (value ?? "").toString().replace(/[&<>"']/g, c => {
        switch (c) {
          case "&": return "&amp;";
          case "<": return "&lt;";
          case ">": return "&gt;";
          case '"': return "&quot;";
          default:  return "&#39;";
        }
      });
    }

    function setAuth(token, cid){
      if (token) {
        localStorage.setItem(tokenKey, token);
        localStorage.setItem("bj_jwt", token);
        window.dispatchEvent(new CustomEvent("bj:auth", { detail: { token } }));
      }
      if (cid) localStorage.setItem(customerKey, cid);
    }
    function getToken(){ return localStorage.getItem(tokenKey); }
    function getCid(){ return localStorage.getItem(customerKey); }
    function clearAuth(){
      localStorage.removeItem(tokenKey);
      localStorage.removeItem(customerKey);
      localStorage.removeItem("bj_jwt");
    }

    function logout(){
      clearAuth();
      app.classList.add("hidden");
      loginCard.classList.remove("hidden");
      who.textContent = "";
      filesUl.innerHTML = "";
    }

    async function deleteAccount() {
      if (!confirm("√Ñr du s√§ker p√• att du vill radera ditt konto och alla uppladdade filer?")) return;
      if (!confirm("Detta g√•r inte att √•ngra. Kvitton/fakturor ligger kvar i Stripe. Forts√§tt?")) return;

      try {
        showLoading("Raderar konto‚Ä¶");

        const { res, data } = await api("/api/portal/account", {
          method: "DELETE",
          body: JSON.stringify({
            cancelStripeSubscriptions: true,
            deleteStripeCustomer: false
          })
        });

        hideLoading();

        if (res.status === 401) {
          logout();
          return;
        }

        if (!res.ok) {
          const msg =
            (data && typeof data === "object" && (data.error || data.message)) ||
            (typeof data === "string" ? data : "Kunde inte radera kontot.");
          alert(msg);
          return;
        }

        alert("Ditt konto och dina uppladdade filer har nu raderats. Eventuella kvitton finns kvar i Stripe f√∂r bokf√∂ring.");
        logout();
        window.location.href = "index.html";
      } catch (e) {
        hideLoading();
        console.error(e);
        alert("N√•got gick fel n√§r kontot skulle raderas. F√∂rs√∂k igen eller kontakta support.");
      }
    }

    async function saveAccount() {
      if (!accNameInput || !accEmailInput || !accDomainInput) return;

      accountMsg.textContent = "";
      accountMsg.classList.remove("err");

      const body = {
        name: accNameInput.value.trim() || null,
        email: accEmailInput.value.trim() || null,
        websiteUrl: accDomainInput.value.trim() || null
      };

      try {
        const { res, data } = await api("/api/portal/account", {
          method: "PATCH",
          body: JSON.stringify(body)
        });

        if (res.status === 401) {
          logout();
          return;
        }

        if (!res.ok) {
          const msg =
            (data && typeof data === "object" && (data.error || data.message)) ||
            (typeof data === "string" ? data : "Kunde inte spara √§ndringarna.");
          accountMsg.textContent = msg;
          accountMsg.classList.add("err");
          return;
        }

        accountMsg.textContent = "√Ñndringarna √§r sparade.";
        accountMsg.classList.remove("err");

        await loadMeAndRenderWho();

      } catch (e) {
        console.error(e);
        accountMsg.textContent = "N√•got gick fel n√§r √§ndringarna skulle sparas.";
        accountMsg.classList.add("err");
      }
    }

      async function saveTheme() {
      if (!themeMsg) return;

      themeMsg.textContent = "";
      themeMsg.classList.remove("err");

      const body = {
        launcherIcon:    (themeLauncherIconInput?.value || "").trim() || null,
        primaryColor:    (themePrimaryColor?.value || "").trim() || null,
        userBubbleColor: (themeUserBubble?.value || "").trim() || null,
        botBubbleColor:  (themeBotBubble?.value || "").trim() || null,
        fontFamily:      (themeFont?.value || "").trim() || null
      };

      try {
        const { res, data } = await api("/api/portal/theme", {
          method: "PATCH",
          body: JSON.stringify(body)
        });

        if (res.status === 401) {
          logout();
          return;
        }

        if (!res.ok) {
          const msg =
            (data && typeof data === "object" && (data.error || data.message)) ||
            (typeof data === "string" ? data : "Kunde inte spara utseendet.");
          themeMsg.textContent = msg;
          themeMsg.classList.add("err");
          return;
        }

        themeMsg.textContent = "Utseendet √§r sparat.";
        themeMsg.classList.remove("err");

        // ladda om f√∂rhandsvisningen med nya f√§rgerna
        refreshChatPreview();

      } catch (e) {
        console.error(e);
        themeMsg.textContent = "N√•got gick fel n√§r utseendet skulle sparas.";
        themeMsg.classList.add("err");
      }
    }

  function resetThemeToDefaults() {
  if (themePrimaryColor) themePrimaryColor.value = "#2563eb";
  if (themeUserBubble)   themeUserBubble.value   = "#eef2ff";
  if (themeBotBubble)    themeBotBubble.value    = "#dcfce7";
  if (themeFont)         themeFont.value         = "";

  if (themeLauncherEmojiInput) themeLauncherEmojiInput.value = "üí¨";
  setLauncherIconValue("emoji");

  if (themeMsg) {
    themeMsg.textContent = "Standardutseende √•terst√§llt ‚Äì gl√∂m inte att spara.";
    themeMsg.classList.remove("err");
  }
}


        function refreshChatPreview() {
      if (!chatPreviewFrame) return;

      const cid = getCid();
      if (!cid || !API) {
        chatPreviewFrame.srcdoc =
          "<p style='font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:12px;color:#64748b'>" +
          "Logga in f√∂r att se f√∂rhandsvisningen." +
          "</p>";
        return;
      }

      const sid = makeSid();
      const url =
        WIDGET_URL +
        "?customerId=" + encodeURIComponent(cid) +
        "&api="        + encodeURIComponent(API) +
        "&preview=1" +
        "&sessionId="  + encodeURIComponent(sid);

      chatPreviewFrame.removeAttribute("srcdoc");
      chatPreviewFrame.src = url;
    }

      function applyThemeFormFromData(me) {
      if (!me) return;
      const t = me.theme || {};

      const launcherIcon = t.launcherIcon || null;
      const primaryColor = t.primaryColor || null;
      const userBubble   = t.userBubbleColor || null;
      const botBubble    = t.botBubbleColor || null;
      const fontFamily   = t.fontFamily || null;

      if (launcherIcon) {
        if (launcherIcon.startsWith("preset:")) {
          setLauncherIconValue(launcherIcon);
        } else {
          if (themeLauncherEmojiInput) themeLauncherEmojiInput.value = launcherIcon;
          setLauncherIconValue("emoji");
        }
      } else {
        setLauncherIconValue("preset:bubble");
      }

      if (themePrimaryColor && primaryColor) themePrimaryColor.value = primaryColor;
      if (themeUserBubble && userBubble)     themeUserBubble.value  = userBubble;
      if (themeBotBubble && botBubble)       themeBotBubble.value   = botBubble;
      if (themeFont && fontFamily)           themeFont.value        = fontFamily;

      syncColorLabel(themePrimaryColor, themePrimaryCodeSpan);
      syncColorLabel(themeUserBubble,  themeUserCodeSpan);
      syncColorLabel(themeBotBubble,   themeBotCodeSpan);
    }



      async function loadMeAndRenderWho() {
      const who       = document.getElementById("who");
      const whoDomain = document.getElementById("whoDomain");
      const cid       = getCid();

      const fallback = cid ? `Inloggad (kund-ID ${cid})` : "Inloggad kund";

      try {
        const { res, data } = await api("/api/portal/me");
        if (!res.ok || !data || typeof data !== "object") {
          who.textContent = fallback;
          if (whoDomain) whoDomain.textContent = "";
          return;
        }

        const company =
          data.companyName || data.name || data.friendlyName || data.organizationName || "";
        const domainRaw =
          data.websiteUrl || data.website || data.domain || data.siteDomain || "";
        let domainText = domainRaw;

        try {
          if (domainRaw) {
            domainText = new URL(domainRaw).host || domainRaw;
          }
        } catch {
          // om parse failar, anv√§nd r√• text
        }

        const parts = [];
        if (company) parts.push(company);
        if (cid)     parts.push("kund-ID " + cid);

        who.textContent = parts.length
          ? "Inloggad: " + parts.join(" ‚Ä¢ ")
          : fallback;

        if (whoDomain) {
          whoDomain.textContent = domainText
            ? "Dom√§n: " + domainText
            : "";
        }

        // Fyll konto-f√§lten
        if (accNameInput)   accNameInput.value   = company || "";
        if (accEmailInput)  accEmailInput.value  = data.email || "";
        if (accDomainInput) accDomainInput.value = domainRaw || "";

        
        applyThemeFormFromData(data);

      } catch (e) {
        who.textContent = fallback;
        if (whoDomain) whoDomain.textContent = "";
      }
    }


    async function readBody(res){
      const text = await res.text();
      if (!text) return null;
      const ct = (res.headers.get("content-type") || "").toLowerCase();
      if (ct.includes("application/json")) {
        try { return JSON.parse(text); } catch { }
      }
      return text;
    }

    async function api(path, opts = {}){
      const headers = Object.assign({}, opts.headers || {});
      const tok = getToken();
      if (tok) headers.Authorization = "Bearer " + tok;
      if (!headers["Content-Type"] && typeof opts.body === "string") {
        headers["Content-Type"] = "application/json";
      }
      const res = await fetch(API + path, { ...opts, headers });
      const data = await readBody(res);
      return { res, data };
    }

    async function getStatusRaw(){
      const { res, data } = await api("/api/uploads/status");
      if (!res.ok || !Array.isArray(data)) return [];
      return data;
    }

    async function pollUntilIndexed(objectNames, timeout=20000, interval=1200){
      const deadline = Date.now() + timeout;
      while(Date.now() < deadline){
        const list = await getStatusRaw();
        const done = objectNames.every(n => list.find(x => x.objectName === n)?.indexed);
        if (done) { await refreshStatus(); return true; }
        await new Promise(r => setTimeout(r, interval));
      }
      await refreshStatus();
      return false;
    }

    async function login(){
      const customerId = document.getElementById("cid").value.trim();
      const email      = document.getElementById("email").value.trim();
      const msg        = document.getElementById("loginMsg");

      msg.textContent = "";
      msg.classList.add("hidden");

      try{
        showLoading("Loggar in‚Ä¶");
        const res  = await fetch(API + "/api/portal/login", {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({ customerId, email })
        });
        const data = await readBody(res);

        if (!res.ok) {
          const errText =
            (data && typeof data === "object" && (data.error || data.message)) ||
            (typeof data === "string" ? data : "Felaktiga uppgifter.");
          throw new Error(errText);
        }

        if (data && data.demo && data.token && data.customerId) {
          setAuth(data.token, data.customerId);

          hideLoading();
          loginCard.classList.add("hidden");
          app.classList.remove("hidden");
          successLink.href = "success.html?cid=" + encodeURIComponent(data.customerId);

          await loadMeAndRenderWho();
          await refreshStatus();

          msg.textContent = "Du √§r nu inloggad som demo-kund.";
          msg.classList.remove("hidden");
          msg.classList.remove("err");
          return;
        }

        hideLoading();
        msg.textContent =
          (data && data.message) ||
          "Om uppgifterna st√§mmer har vi skickat en inloggningsl√§nk till din e-post.";
        msg.classList.remove("hidden");
        msg.classList.remove("err");

      }catch(e){
        hideLoading();
        msg.textContent = e.message || "Kunde inte skicka inloggningsl√§nk.";
        msg.classList.remove("hidden");
        msg.classList.add("err");
      }
    }

    function renderFiles(){
      filesUl.innerHTML = "";

      if (!Array.isArray(filesCache) || filesCache.length === 0) {
        filesUl.innerHTML = "<li class='muted'>Inga filer √§nnu.</li>";
        return;
      }

      const q = (fileSearchInput?.value || "").trim().toLowerCase();

      let list = filesCache.slice();

      if (q) {
        list = list.filter(it => {
          const name = (it.displayName || it.objectName || "").toLowerCase();
          const kind = (it.contentType || "").toLowerCase();
          return name.includes(q) || kind.includes(q);
        });
      }

      list.sort((a, b) => {
        const na = (a.displayName || a.objectName || "").toLowerCase();
        const nb = (b.displayName || b.objectName || "").toLowerCase();
        if (na < nb) return sortAscending ? -1 : 1;
        if (na > nb) return sortAscending ? 1 : -1;
        return 0;
      });

      if (list.length === 0) {
        filesUl.innerHTML = "<li class='muted'>Inga dokument matchade din s√∂kning.</li>";
        return;
      }

      for (const it of list){
        const li   = document.createElement("li");
        const when = it.lastModified ? new Date(it.lastModified).toLocaleString() : "-";

        const indexedHtml = it.indexed
          ? ' ‚Ä¢ <span class="status-pill ok">indexerad' +
              (it.indexedAtUtc ? ' (' + new Date(it.indexedAtUtc).toLocaleString() + ')' : '') +
            '</span>'
          : ' ‚Ä¢ <span class="status-pill pending">ej indexerad</span>';

        const rawName =
          (it.displayName && it.displayName.trim())
            ? it.displayName
            : (it.objectName || "").split('/').pop();

        const safeName       = esc(rawName);
        const safeContent    = esc(it.contentType || "ok√§nd");
        const safeObjectName = esc(it.objectName || "");

        li.innerHTML = `
          <div class="row">
            <div class="doc-meta">
               <strong>${safeName}</strong>
              <div class="meta-line">
                ${safeContent} ‚Ä¢ ${it.sizeBytes ? (it.sizeBytes/1024/1024).toFixed(2) + " MB" : "-"} ‚Ä¢ Uppdaterad ${when}
                ${indexedHtml}
              </div>
            </div>
            <div class="doc-actions">
              <button class="btn secondary" data-act="reindex" data-name="${safeObjectName}">Reindex</button>
              <button class="btn ghost" data-act="delete" data-name="${safeObjectName}">Ta bort</button>
            </div>
          </div>`;
        filesUl.appendChild(li);
      }

      filesUl.querySelectorAll('button[data-act="reindex"]').forEach(b => {
        b.onclick = () => reindexOne(b.dataset.name);
      });
      filesUl.querySelectorAll('button[data-act="delete"]').forEach(b => {
        b.onclick = () => deleteOne(b.dataset.name);
      });
    }

    async function refreshStatus(){
      filesUl.innerHTML = "<li class='muted'>Laddar‚Ä¶</li>";
      const { res, data } = await api("/api/uploads/status");

      if (res.status === 401) {
        filesUl.innerHTML = "<li class='banner err'>Sessionen har g√•tt ut. Logga in igen.</li>";
        logout();
        return;
      }

      if (!res.ok) {
        const errText = (typeof data === "string" ? data : "Kunde inte h√§mta status.");
        filesUl.innerHTML = `<li class='banner err'>${esc(errText)}</li>`;
        return;
      }

      if (!Array.isArray(data)) {
        filesCache = [];
      } else {
        filesCache = data;
      }

      renderFiles();
    }

    async function reindexWebsite(){
      const { res, data } = await api("/api/portal/reindex-website", {
        method: "POST"
      });

      if (res.status === 401) return logout();

      if (!res.ok) {
        const msg =
          (data && typeof data === "object" && (data.error || data.message)) ||
          (typeof data === "string" ? data : "Kunde inte starta reindexering av webbplatsen.");
        alert(msg);
        return;
      }

      alert("Webbplatsen har k√∂ats f√∂r ny indexering. Det kan ta upp till n√•gon minut innan svaren uppdateras.");
    }

    async function reindexAll(){
      const before = await getStatusRaw();
      const names = before.map(d => d.objectName);

      const { res, data } = await api("/api/uploads/reindex", {
        method: "POST",
        body: JSON.stringify({ objectName: null })
      });
      if (res.status === 401) return logout();
      if (!res.ok) alert(typeof data === "string" ? data : "Kunde inte starta reindex.");

      await pollUntilIndexed(names);
    }

    async function reindexOne(name){
      const { res, data } = await api("/api/uploads/reindex", {
        method: "POST",
        body: JSON.stringify({ objectName: name })
      });
      if (res.status === 401) return logout();
      if (!res.ok) alert(typeof data === "string" ? data : "Kunde inte reindexera filen.");
      await pollUntilIndexed([name]);
    }

    async function deleteOne(name){
      if(!confirm("Ta bort filen?")) return;
      const { res, data } = await api("/api/uploads/file", {
        method: "DELETE",
        body: JSON.stringify({ objectName: name })
      });
      if (res.status === 401) return logout();
      if (!res.ok) alert(typeof data === "string" ? data : "Kunde inte ta bort filen.");
      await refreshStatus();
    }

    async function upload(){
      const files = document.getElementById("file").files;
      if(!files || files.length===0) return;

      const uploaded = [];

      for (const f of files){
        const li = document.createElement("li");
        li.textContent = `Laddar upp ${f.name}‚Ä¶`;
        logUl.appendChild(li);

        let start;
        try{
          start = await api("/api/uploads/start", {
            method:"POST",
            body: JSON.stringify({ fileName: f.name, contentType: f.type || "application/octet-stream" })
          });
        }catch(err){
          li.textContent = `N√§tverksfel (start): ${err?.message || err}`;
          continue;
        }
        if (start.res.status === 401) { logout(); return; }
        if (!start.res.ok || !start.data || !start.data.uploadUrl){
          li.textContent = `Fel vid start: ${typeof start.data === "string" ? start.data : "ok√§nt fel"}`;
          continue;
        }

        try{
          const put = await fetch(start.data.uploadUrl, {
            method: "PUT",
            headers: { "x-ms-blob-type":"BlockBlob", "Content-Type": f.type || "application/octet-stream" },
            body: f
          });
          if (!put.ok){
            li.textContent = `Fel vid PUT: ${put.status}`;
            continue;
          }
        }catch(err){
          li.textContent = `N√§tverksfel (PUT): ${err?.message || err}`;
          continue;
        }

        try{
          const comp = await api("/api/uploads/complete", {
            method: "POST",
            body: JSON.stringify({
              objectName: start.data.objectName,
              sizeBytes:  f.size,
              contentType: f.type || "text/plain",
              originalName: f.name
            })
          });

          if (!comp.res.ok){
            li.textContent = `Fel vid complete: ${typeof comp.data === "string" ? comp.data : "ok√§nt fel"}`;
            continue;
          }
        }catch(err){
          li.textContent = `N√§tverksfel (complete): ${err?.message || err}`;
          continue;
        }

        uploaded.push(start.data.objectName);
        li.innerHTML = `<span class="status-ok">‚úî</span> Klar: ${esc(f.name)}`;
      }

      if (uploaded.length){
        await pollUntilIndexed(uploaded);
      }else{
        await refreshStatus();
      }
    }

    document.getElementById("loginBtn").onclick      = login;
    document.getElementById("logoutBtn").onclick     = logout;
    document.getElementById("refreshBtn").onclick    = refreshStatus;
    document.getElementById("uploadBtn").onclick     = upload;
    document.getElementById("reindexAllBtn").onclick = reindexAll;
    document.getElementById("reindexSiteBtn").onclick = reindexWebsite;
    document.getElementById("email").addEventListener("keydown", (e)=>{ if (e.key === "Enter") login(); });
    document.getElementById("saveAccountBtn").onclick = saveAccount;
    document.getElementById("deleteAccountBtn").onclick = deleteAccount;

    if (themeSaveBtn) {
      themeSaveBtn.addEventListener("click", (e) => {
        e.preventDefault();
        saveTheme();
      });
    }

    if (themeResetBtn) {
      themeResetBtn.addEventListener("click", (e) => {
        e.preventDefault();
        resetThemeToDefaults();
      });
    }


    if (reloadPreviewBtn && chatPreviewFrame) {
      reloadPreviewBtn.addEventListener("click", () => {
        chatPreviewFrame.src = chatPreviewFrame.src;
      });
    }

    if (fileSearchInput) {
      fileSearchInput.addEventListener("input", () => {
        renderFiles();
      });
    }

    if (sortByNameBtn) {
      sortByNameBtn.addEventListener("click", () => {
        sortAscending = !sortAscending;
        sortByNameBtn.textContent = sortAscending ? "Sortera A‚Äì√ñ" : "Sortera √ñ‚ÄìA";
        renderFiles();
      });
    }

    (async function boot(){
      const url         = new URL(location.href);
      const tokenFromUrl = url.searchParams.get("token") || url.searchParams.get("jwt");
      const cidFromUrl   = url.searchParams.get("cid");

      if (tokenFromUrl) {
        setAuth(tokenFromUrl, cidFromUrl || null);

        url.searchParams.delete("token");
        url.searchParams.delete("jwt");
        if (cidFromUrl) {
          url.searchParams.set("cid", cidFromUrl);
        }
        history.replaceState({}, "", url.toString());
      }

      const token = getToken();
      const cid   = getCid();

      if (token && cid){
        loginCard.classList.add("hidden");
        app.classList.remove("hidden");
        successLink.href = "success.html?cid=" + encodeURIComponent(cid);

        await loadMeAndRenderWho();
        await refreshStatus();
        await loadMeAndRenderWho();
        await refreshStatus();
        refreshChatPreview();   

      }
    })();
  </script>

  <!-- Intro-text login/loggad in -->
  <script>
  (function() {
    const intro = document.getElementById("introText");

    function setLoggedOutText() {
      if (!intro) return;
      intro.innerHTML = `
        Logga in med ditt <strong>kund-ID</strong> och den <strong>e-post</strong> som angavs vid registrering.
        Du f√•r en inloggningsl√§nk skickad till din e-post.
        H√§r kan du ladda upp dokument (PDF/DOCX/TXT/MD), se status, reindexera och ta bort filer.
        N√§r en fil √§r <strong>indexerad</strong> anv√§nds dess inneh√•ll som kontext n√§r din bot svarar.
      `;
    }

    function setLoggedInText() {
      if (!intro) return;
      intro.innerHTML = `
        H√§r kan du ladda upp dokument (PDF/DOCX/TXT/MD), se status, reindexera och ta bort filer.
        N√§r en fil √§r <strong>indexerad</strong> anv√§nds dess inneh√•ll som kontext n√§r din bot svarar.
        F√•r du slut p√• fr√•gor kan du alltid k√∂pa fler enkelt genom att klicka p√• knappen
        <strong>"K√∂p fler fr√•gor"</strong>.
      `;
    }

    window.addEventListener("bj:auth", () => {
      setLoggedInText();
    });

    const token = localStorage.getItem("botjahl.portal.token") ||
                  localStorage.getItem("bj_jwt");

    if (token) {
      setLoggedInText();
    } else {
      setLoggedOutText();
    }
  })();
  </script>

  <!-- Quota + me card driver -->
  <script>
  (function () {
    const rawBase2 = (window.API_BASE || window.API || "").trim();

    if (!rawBase2) {
      console.error("API_BASE saknas! Kontrollera att __API_BASE__ har injicerats");
    }

    const API_BASE = rawBase2.replace(/\/+$/, "");

    function readCookie(name) {
      const m = document.cookie.match(
        new RegExp("(^|; )" + name.replace(/([.$?*|{}()[\]\\/+^])/g, "\\$1") + "=([^;]*)")
      );
      return m ? decodeURIComponent(m[2]) : "";
    }

    function getBestToken() {
      const storageKeys = ["bj_jwt", "jwt", "token", "botjahl.portal.token"];
      for (const k of storageKeys) {
        const v = localStorage.getItem(k) || sessionStorage.getItem(k);
        if (v) return v;
      }

      if (window.JWT) return window.JWT;

      const cookieKeys = ["bj_jwt", "jwt", "token", "botjahl.portal.token"];
      for (const ck of cookieKeys) {
        const v = readCookie(ck);
        if (v) return v;
      }
      return "";
    }

    async function fetchJson(path) {
      const token = getBestToken();
      if (!token) {
        throw new Error("no_token");
      }

      const res = await fetch(`${API_BASE}${path}`, {
        headers: {
          "Authorization": `Bearer ${token}`,
          "Accept": "application/json"
        }
      });

      let data = null;
      try {
        data = await res.json();
      } catch {}

      if (res.status === 401) {
        try {
          localStorage.removeItem("botjahl.portal.token");
          localStorage.removeItem("bj_jwt");
          localStorage.removeItem("jwt");
          localStorage.removeItem("token");
        } catch {}

        throw new Error("unauthorized");
      }

      if (!res.ok) {
        throw new Error((data && data.error) || `HTTP ${res.status}`);
      }

      return data;
    }

    const card   = document.getElementById("quota-card");
    const sub    = document.getElementById("quota-sub");
    const pill   = document.getElementById("quota-pill");
    const bar    = document.getElementById("quota-bar");
    const foot   = document.getElementById("quota-foot");
    const domain = document.getElementById("quota-domain");

    function renderUsage(u) {
      card.style.display = "";

      const percent = Math.max(0, Math.min(100, Math.round(u.percent ?? 0)));
      sub.textContent = `Plan: ${u.plan} ‚Ä¢ ${u.usedMB} av ${u.limitMB} MB`;

      bar.style.width = `${percent}%`;
      pill.textContent = `${percent}%`;
      pill.className = "status-pill " + (percent >= 90 ? "pending" : "ok");

      const left = Math.max(0, (u.limitMB ?? 0) - (u.usedMB ?? 0));
      foot.textContent = `${u.usedMB} MB av ${u.limitMB} MB anv√§nt ¬∑ ${left} MB kvar i din kvot.`;
    }

    function renderDomain(info) {
      if (!domain) return;

      if (info && info.websiteUrl) {
        try {
          const host = new URL(info.websiteUrl).host;
          if (host) {
            domain.textContent = `Dom√§n: ${host}`;
            domain.style.display = "";
            return;
          }
        } catch {}
      }

      domain.textContent = "";
      domain.style.display = "none";
    }

    function renderLoggedOut() {
      card.style.display = "";
      sub.textContent = "Logga in f√∂r att se anv√§ndning.";
      pill.textContent = "‚Äî";
      pill.className = "status-pill ok";
      bar.style.width = "0%";
      foot.textContent = "";
      if (domain) {
        domain.textContent = "";
        domain.style.display = "none";
      }
    }

    async function tick() {
      const rawToken = getBestToken();
      if (!rawToken) {
        renderLoggedOut();
        return;
      }

      try {
        const [usage, me] = await Promise.all([
          fetchJson("/api/uploads/usage"),
          fetchJson("/api/portal/me")
        ]);

        renderUsage(usage);
        renderDomain(me);
      } catch (err) {
        if (err && (err.message === "no_token" || err.message === "unauthorized")) {
          renderLoggedOut();
          return;
        }

        console.error("usage / me error:", err);
        renderLoggedOut();
      }
    }

    window.addEventListener("storage", (e) => {
      if (["botjahl.portal.token", "bj_jwt", "jwt", "token", "auth_token"].includes(e.key)) {
        tick();
      }
    });
    window.addEventListener("bj:auth", () => tick());

    tick();
    setInterval(tick, 60000);
  })();
  </script>

  <!-- Chat usage card driver -->
  <script>
  (function(){
    const rawBase3 = (window.API_BASE || window.API || "").trim();

    if (!rawBase3) {
      console.error("API_BASE saknas! Kontrollera att __API_BASE__ har injicerats av GitHub Actions.");
    }

    const API_BASE = rawBase3.replace(/\/+$/,"");

    function readCookie(name){
      const parts = document.cookie.split(";");
      for (let p of parts){
        p = p.trim();
        if (!p) continue;
        if (p.startsWith(name + "=")){
          return decodeURIComponent(p.substring(name.length + 1));
        }
      }
      return null;
    }

    function getToken(){
      const qs = new URLSearchParams(location.search);
      const fromUrl = qs.get("token") || qs.get("jwt");
      if (fromUrl) return fromUrl;

      const keys = [ "botjahl.portal.token", "bj_jwt", "jwt", "token", "auth_token" ];
      for (const k of keys){
        const v = localStorage.getItem(k) || readCookie(k);
        if (v) return v;
      }
      return null;
    }

    async function fetchChatUsage(token){
      const res = await fetch(`${API_BASE}/api/usage/chat`, {
        headers: { "Authorization": `Bearer ${token}` }
      });
      if (!res.ok){
        const t = await res.text().catch(()=> "");
        throw new Error(`HTTP ${res.status} ${t || ""}`);
      }
      return res.json();
    }

    const card = document.getElementById("chat-usage-card");
    const sub  = document.getElementById("chat-usage-sub");
    const pill = document.getElementById("chat-usage-pill");
    const bar  = document.getElementById("chat-usage-bar");
    const foot = document.getElementById("chat-usage-foot");
    const buyBtn = document.getElementById("buyQuestionsBtn");

    function render(u){
      card.style.display = "";
      sub.textContent = `Plan: ${u.plan ?? "ok√§nd"} ‚Ä¢ ${u.used} av ${u.limit} fr√•gor f√∂rbrukade`;
      bar.style.width = `${u.percent}%`;
      pill.textContent = `${u.percent}%`;
      pill.className = "status-pill " + (u.percent >= 100 ? "pending" : "ok");
      foot.textContent = `${u.remaining} fr√•gor kvar i din kvot (${u.extraCredits} extra i potten).`;
    }

    function renderLoggedOut(){
      card.style.display = "";
      sub.textContent = "Logga in f√∂r att se fr√•geanv√§ndning.";
      pill.textContent = "‚Äî";
      bar.style.width = "0%";
      foot.textContent = "";
    }

    async function tick(){
      const token = getToken();
      if (!token){ renderLoggedOut(); return; }
      try{
        const u = await fetchChatUsage(token);
        render(u);
      }catch(err){
        card.style.display = "";
        sub.textContent = "Kunde inte l√§sa fr√•geanv√§ndning.";
        pill.textContent = "‚Äî";
        bar.style.width = "0%";
        foot.textContent = "";
        console.error(err);
      }
    }

    if (card){
      tick();
      setInterval(tick, 60000);
    }

    if (buyBtn){
      buyBtn.addEventListener("click", async ()=>{
        const token = getToken();
        if (!token){
          alert("Logga in igen f√∂r att kunna k√∂pa fler fr√•gor.");
          return;
        }

        try{
          const res = await fetch(`${API_BASE}/api/billing/topup-questions`, {
            method: "POST",
            headers: {
              "Authorization": `Bearer ${token}`,
              "Content-Type": "application/json"
            },
            body: JSON.stringify({ pack: "small" })
          });
          const data = await res.json();
          if (!res.ok || !data.url){
            alert(data.error || "Kunde inte starta k√∂p av fr√•gor.");
            return;
          }
          location.href = data.url;
        }catch(err){
          console.error(err);
          alert("N√•got gick fel n√§r k√∂pet skulle startas.");
        }
      });
    }
  })();
  </script>

  <!-- Global 401-hanterare -->
  <script>
  (function() {
    const TOKEN_KEYS = [
      "botjahl.portal.token",
      "bj_jwt",
      "jwt",
      "token",
      "auth_token"
    ];

    function clearAllTokens() {
      try {
        for (const key of TOKEN_KEYS) {
          localStorage.removeItem(key);
          sessionStorage.removeItem(key);
          document.cookie = key + "=; Max-Age=0; path=/;";
        }
      } catch (e) {
        console.warn("Token cleanup failed:", e);
      }
    }

    function getStoredToken() {
      for (const key of TOKEN_KEYS) {
        const v =
          localStorage.getItem(key) ||
          sessionStorage.getItem(key);
        if (v) return v;
      }
      return null;
    }

    window.addEventListener("bj:auth", () => {
      const token = getStoredToken();
      if (!token) return;
      console.log("Auth stored:", token.substring(0, 20) + "...");
    });

    const origFetch = window.fetch;
    window.fetch = async function(url, opts = {}) {
      const resp = await origFetch(url, opts);

      if (resp.status === 401) {
        console.warn("401 detected ‚Äì clearing tokens automatically‚Ä¶");
        clearAllTokens();

        const app = document.getElementById("app");
        const login = document.getElementById("login-card");
        if (app && login) {
          app.classList.add("hidden");
          login.classList.remove("hidden");
        }
      }

      return resp;
    };

    document.addEventListener("DOMContentLoaded", () => {
      const token = getStoredToken();
      const app = document.getElementById("app");
      const login = document.getElementById("login-card");

      if (!token) {
        console.log("No valid token found on load ‚Äî showing login");
        if (app && login) {
          app.classList.add("hidden");
          login.classList.remove("hidden");
        }
      }
    });
  })();
  </script>
</body>
</html>
